登录鉴权
----
从“古”至今有很多登录和鉴权的解决方案，本案来串一番。

+ SessionID，Session & Cookie
+ Token, Access Token
+ JWT Token
+ IAM/OIDC

# SessionID
上古时代，
服务端登录流程走完之后，生成一条随机字符串key，val是用户的session信息。key作为登录成功的标识，存放在前端cookie中。
集群场景中、反向代理和负载均衡策略使用后，多个Web应用之间共享Session，最简单的实现就是有 Session集中管理服务，比如把Session放到redis集群。

有安全风险的SessionID可以通过一些模式识别，标记，干掉。

结构简单，运行高效。

session生命周期后台可控；单点故障风险、缓存随用户量线性增长；冗余校验问题；

# Token
微服务时代，
多个服务间调用，组成了超长的请求链路，如果使用Session，就会反复读取Session信息。
另一种方案是Token方案，一个编码过的、防篡改的、携带业务信息的自包含机制 ---- Token。
登录成功，服务端返回给客户端一个经过编码的Token，客户端保管下来（服务端不存），后续的请求带着这个token，应用服务可以直接从token获取用户信息。
如果token的加密或校验措施不到位，就会有安全问题；token信息较多，外网传输增加了网络带宽负载。

对于客户端，token和sessionID差异不大；服务端的行为差异较大。服务端需要解析token、校验token等。

token签发后，难以回收（难以限制）；服务

# SSO
一个公司可能有多个网络系统，要抽离这多个系统的登录模块、实现跨系统的免重复登录，就需要SSO single sign on。
+ 提供一个统一的登录网页，后台使用中心化的token签发和鉴权
+ 其他系统都作为外部接入方，使用OAuth2（一般选择，另外有SAML策略）

IAM 则是身份管理体系的解决方案，包括配置化、动态认证、云端IDaaS、风险识别等机制，是IBM为大型企业用户身份认证的一揽子解决方案。

## IAM
Identity and Access Management, 身份识别和访问管理，包括单点登录、强大的认证管理、基于策略的集中式授权和审计、动态授权、企业可管理性等功能。

动态授权，从不同本地或外部源（包括Web服务和数据库）实时触发评估数据的安全策略，从而确定进行访问授权或拒绝访问。通过环境相关的评估，可获得更加细化的授权。

MFA，多重认证，用户不仅必须提供使用账户所需的密码或访问密钥，还必须提供来自经过特殊配置的设备的代码。

4A安全模型，认证、授权、审计、账号管理

## SAML
Security Assertion Markup Language, SAML, 安全断言标记语言，基于XML的开源数据格式。SAML在身份提供者和服务提供者之间交换身份验证和授权数据

## 第三方给登录
第三方公司的系统，使用一个公司的用户登录，并获取用户的账号、头像、性别等信息。
+ 第三方系统不会获得用户的密码
+ 第三方系统是该公司认证过的
+ 第三方的访问是用户授权的

## OAuth2.0 授权
OAuth 是一个开放授权标准，一个系统允许用户授权第三方网站访问该系统上的信息，但不提供账户和密码，甚至只提供很少的信息。

```OAuth2.0的四大角色 和 2次跳转```
+ Resource Owner -- 资源所有者，终端用户。只有用户授权，第三方参能获取
+ Resource Server -- 资源服务者，用户账户所在平台
+ Client -- 客户端，第三方app，需要接入资源服务者，接受其资质审核。
+ Authorization Server -- 授权服务器，（一般情况）可以是资源服务者的同一家公司的系统，也可以是是第三方服务？


+ 第一次跳转，用户在第三方APP中触发跳转资源服务（RS）的账户登录页面去填写用户密码。
+ 第二次跳转，用户登录后，跳转会第三方。
    + 每个第三方有个AppID标识
    + 登录后，RS记录（用户信息、AppID）并生成code，code递交到第三方
        +  code有效期很短，用后即删
    + 第三方用（AppID、私钥、code）向RS请求access_token
        + OAuth2 并没有规定access token的形式，可以是个字符串，也可以是jwt。
    + 第三方APP可以把access_token保存下来，一段时间内可以用这个token获取用户信息

### JWT
JSON Web Token，包含业务数据的token格式，由数据头、数据体、签名组成，编码后可得jwt。
+ 数据头，标识内容格式、算法
+ 数据体，保存要传递的数据，用户信息
+ 签名，对参数的加签散列串，防篡改

JWT不需要拿着token到鉴权服务确认，服务可以解析JWT获得用户信息。
安全要求不高的服务，可以用HTTPS做前端传输对称加密的用户JWT。

### 双Token设计
```遇事不决，拆分解决。```
access_token，如jwt，一旦签发，难以收回，永久有效带来安全问题，所以一般都设定过期期限。
access_token过期后，就需要重新发起二次跳转来刷新，太短的期限影响用户体验。

一般，RS还向第三方APP签发一个refresh token，比如7天有效；而access_token短时间有效，比如15分钟。后者过期后，第三方APP后台用refresh_token向RS刷新access_token。

如果refresh_token被非法滥用，则会破环整个机制，因此refresh_token在access_token过期刷新时，refresh_token也会刷新，旧的立即作废。

### CSRF攻击
只要使用header传输token、签名字段验证、时间字段过滤、refresh机制兜底和关键请求referer判断的话，CSRF攻破的几率是很低的。

# 总
OAuth2 解决的是用户的跨服务资源授权；而登录的本质是身份认证。
而登录行为，也可以看作对用户后续操作资源的授权，这是把授权用于登录的异变使用。
OIDC协议的技术本质和OAuth2是一样的，但业务本质不同。

区分清楚：
+ 登录和授权的不同
+ OAuth2 和 OIDC
+ sessionId 和 token
